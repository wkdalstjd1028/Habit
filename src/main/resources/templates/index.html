<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Mini Habit Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="stylesheet" th:href="@{/css/index.css}">
</head>
<body>
<div th:replace="fragments/header :: siteHeader"></div>
<div class="container">


    <main>
        <section class="hero">
            <h1 class="hero-title">하루 한 번, 잔디 심기 습관 만들기</h1>

            <div class="hero-buttons" sec:authorize="!isAuthenticated()">
                <a class="btn-primary" th:href="@{/user/signup}">지금 시작하기</a>
                <a class="btn-secondary" th:href="@{/user/login}">이미 계정이 있어요</a>
            </div>

            <div class="hero-buttons" sec:authorize="isAuthenticated()">
                <a class="btn-primary" th:href="@{/habit/list}">내 습관 보러가기</a>
                <a class="btn-secondary" th:href="@{/habit/create}">새 습관 등록하기</a>
            </div>

            <div style="
    margin-top: 24px;
    background-color: #0f172a;
    border-radius: 14px;
    padding: 14px 18px;
    color: #e5e7eb;">
                <div style="font-size: 13px; margin-bottom: 8px;">
                    월별 잔디 보기
                    <span id="grass-month-label" style="font-size: 12px; color: #9ca3af; margin-left: 6px;"></span>
                </div>

                <div id="grass-grid"
                     style="display: flex; flex-wrap: wrap; gap: 4px;">
                </div>

                <section class="today-section" sec:authorize="isAuthenticated()"
                         style="margin-top: 20px;">
                    <h2 style="font-size: 15px; font-weight: 600; margin-bottom: 6px;">
                        오늘 해야 할 일
                    </h2>

                    <p id="today-empty"
                       style="font-size: 13px; color: #9ca3af; margin: 4px 0; display: none;">
                        오늘 해야 할 일은 모두 완료했어요
                    </p>

                    <ul id="today-list"
                        style="list-style: none; padding: 0; margin: 0;"></ul>

                    <div style="margin-top: 8px;">
                        <a th:href="@{/habit/list}"
                           style="font-size: 12px; color: #16a34a; text-decoration: none;">
                            내 습관 페이지에서 체크인 하기
                        </a>
                    </div>
                </section>
            </div>
        </section>

    </main>
</div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const grid = document.getElementById("grass-grid");
        const monthLabel = document.getElementById("grass-month-label");

        if (!grid) return;

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        monthLabel.textContent = `${year}-${String(month).padStart(2, "0")}`;

        fetch(`/habit/calendar?year=${year}&month=${month}`)
            .then(res => res.json())
            .then(data => {
                const daysInMonth = new Date(year, month, 0).getDate();
                const checkedSet = new Set(data.checkedDays || []);

                for (let day = 1; day <= daysInMonth; day++) {
                    const dot = document.createElement("div");
                    dot.style.width = "14px";
                    dot.style.height = "14px";
                    dot.style.borderRadius = "4px";
                    dot.style.backgroundColor = checkedSet.has(day) ? "#22c55e" : "#1f2937";
                    grid.appendChild(dot);
                }
            })
            .catch(err => {
                console.error("잔디 데이터 로딩 실패", err);
            });

        const todayList = document.getElementById("today-list");
        const todayEmpty = document.getElementById("today-empty");

        if (todayList) {
            fetch("/habit/today")
                .then(res => res.json())
                .then(habits => {
                    if (!habits || habits.length === 0) {
                        if (todayEmpty) todayEmpty.style.display = "block";
                        return;
                    }

                   habits.forEach(habit => {
                        const li = document.createElement("li");
                        li.classList.add("today-item");

                        const bullet = document.createTextNode("• ");

                        const link = document.createElement("a");
                        link.classList.add("today-link");
                        link.textContent = habit.name;

                        link.href = `/habit/detail/${habit.id}`;;

                        li.appendChild(bullet);
                        li.appendChild(link);
                        todayList.appendChild(li);
                        });

                })
                .catch(err => {
                    console.error("오늘 할 일 로딩 실패", err);
                });
        }
    });
</script>

</html>
