<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>내 습관 | Mini Habit Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/habit-list.css}">
</head>
<body>

<div th:replace="fragments/header :: siteHeader"></div>

<div class="todo-container">
    <h1 class="title">내 습관</h1>

    <div class="todo-input-row">
        <a th:href="@{/habit/create}" class="todo-add-btn">새 습관 등록하기</a>
    </div>

    <div class="todo-filters">
        <button type="button" class="filter active" data-filter="ALL">전체</button>
        <button type="button" class="filter" data-filter="DAILY">매일</button>
        <button type="button" class="filter" data-filter="WEEKLY">매주</button>
        <button type="button" class="filter" data-filter="MONTHLY">매월</button>
        <button type="button" class="filter" data-filter="OTHER">기타</button>
    </div>

    <ul class="todo-list">
        <li class="todo-item" th:if="${#lists.isEmpty(habits)}">
            <span class="empty-message">아직 습관이 없습니다. 먼저 등록하세요.</span>
        </li>

        <li class="todo-item"
            th:each="habit : ${habits}"
            th:attr="data-habit-id=${habit.id},data-habit-type=${habit.habitType}"
            th:classappend="${todayCheckedIds.contains(habit.id)} ? 'done-today'">

            <div class="todo-main">
                <label class="todo-check">
                    <input type="checkbox" class="check-box" th:checked="${todayCheckedIds.contains(habit.id)}"/>
                </label>
                <a th:href="@{|/habit/detail/${habit.id}|}" class="todo-link">
                    <span class="todo-text" th:text="${habit.name}"></span>
                </a>
            </div>

            <div class="todo-actions">
                <button type="button" class="check-btn">체크인</button>
                <a th:href="@{|/habit/edit/${habit.id}|}" class="todo-edit-btn">수정</a>

                <form th:action="@{|/habit/delete/${habit.id}|}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="todo-delete-btn">삭제</button>
                </form>
            </div>
        </li>
    </ul>
</div>

<script>
    document.querySelectorAll(".filter").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".filter").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            const type = btn.dataset.filter;
            document.querySelectorAll(".todo-item").forEach(item => {
                if (type === "ALL") {
                    item.style.display = "flex";
                } else {
                    item.style.display =
                        item.dataset.habitType === type ? "flex" : "none";
                }
            });
        });
    });

    async function toggleCheck(habitId, element) {
        try {
            const response = await fetch(`/habit/check/${habitId}`, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (response.ok) {
                const item = element.closest(".todo-item");
                item.classList.toggle("done-today");
            }
        } catch (e) {
            console.error(e);
        }
    }

    document.querySelectorAll(".check-box").forEach(cb => {
        cb.addEventListener("change", () => {
            const habitId = cb.closest(".todo-item").dataset.habitId;
            toggleCheck(habitId, cb);
        });
    });

    document.querySelectorAll(".check-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const habitId = btn.closest(".todo-item").dataset.habitId;
            toggleCheck(habitId, btn);
        });
    });
</script>

</body>
</html>
