<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ìŠµê´€ | Mini Habit Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/habit-list.css}">
</head>
<body>

<div th:replace="fragments/header :: siteHeader"></div>

<div class="todo-container">
    <h1 class="title">ë‚´ ìŠµê´€</h1>

    <div class="todo-input-row">
        <a th:href="@{/habit/create}" class="todo-add-btn">ìƒˆ ìŠµê´€ ë“±ë¡í•˜ê¸°</a>
    </div>

    <!-- í•„í„° -->
    <div class="todo-filters">
        <button type="button" class="filter active" data-filter="ALL">ì „ì²´</button>
        <button type="button" class="filter" data-filter="DAILY">ë§¤ì¼</button>
        <button type="button" class="filter" data-filter="WEEKLY">ë§¤ì£¼</button>
        <button type="button" class="filter" data-filter="MONTHLY">ë§¤ì›”</button>
        <button type="button" class="filter" data-filter="OTHER">ê¸°íƒ€</button>
    </div>

    <ul class="todo-list">
        <li class="todo-item" th:if="${#lists.isEmpty(habits)}">
            <span class="empty-message">ì•„ì§ ìŠµê´€ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”.</span>
        </li>

        <li class="todo-item"
            th:each="habit : ${habits}"
            th:attr="data-habit-id=${habit.id},data-habit-type=${habit.habitType}"
            th:classappend="${todayCheckedIds.contains(habit.id)} ? 'done-today'">

            <div class="todo-main">
                <label class="todo-check">
                    <input type="checkbox" class="check-box" th:checked="${todayCheckedIds.contains(habit.id)}"/>
                </label>
                <a th:href="@{|/habit/detail/${habit.id}|}" class="todo-link">
                    <span class="todo-text" th:text="${habit.name}"></span>
                </a>
            </div>

            <div class="todo-actions">
                <button type="button" class="check-btn">ì²´í¬ì¸</button>
                <a th:href="@{|/habit/edit/${habit.id}|}" class="todo-edit-btn">ìˆ˜ì •</a>

                <form th:action="@{|/habit/delete/${habit.id}|}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="todo-delete-btn">ì‚­ì œ</button>
                </form>
            </div>
        </li>
    </ul>
</div>

<!-- ğŸ”¥ ì—¬ê¸°ë¶€í„° script ë³µì› & ìµœì¢… ì—…ë°ì´íŠ¸ -->
<script>
    /* âœ” í•„í„° ë²„íŠ¼ í´ë¦­ ì‹œ ìŠµê´€ ë¶„ë¥˜ í‘œì‹œ */
    document.querySelectorAll(".filter").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".filter").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            const type = btn.dataset.filter;
            document.querySelectorAll(".todo-item").forEach(item => {
                if (type === "ALL") {
                    item.style.display = "flex";
                } else {
                    item.style.display =
                        item.dataset.habitType === type ? "flex" : "none";
                }
            });
        });
    });

    /* âœ” ì²´í¬ë°•ìŠ¤ or ì²´í¬ì¸ ë²„íŠ¼ í´ë¦­ â†’ Ajax ì²´í¬ì¸ / ì·¨ì†Œì„  ìœ ì§€ */
    async function toggleCheck(habitId, element) {
        try {
            const response = await fetch(`/habit/check/${habitId}`, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (response.ok) {
                const item = element.closest(".todo-item");
                item.classList.toggle("done-today");
            }
        } catch (e) {
            console.error(e);
        }
    }

    /* ì²´í¬ë°•ìŠ¤ í´ë¦­ */
    document.querySelectorAll(".check-box").forEach(cb => {
        cb.addEventListener("change", () => {
            const habitId = cb.closest(".todo-item").dataset.habitId;
            toggleCheck(habitId, cb);
        });
    });

    /* ì²´í¬ì¸ ë²„íŠ¼ í´ë¦­ */
    document.querySelectorAll(".check-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const habitId = btn.closest(".todo-item").dataset.habitId;
            toggleCheck(habitId, btn);
        });
    });
</script>

</body>
</html>
